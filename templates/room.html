{% extends "base.html" %}

{% block title %}Pandora's Engine -- Game Room{% endblock %}

{% block active_link %}room-link{% endblock %}

{% block body %}
    <center>
        <div id="pre-game">
            <label> Players currently in the room </label>
            <ul id="player-list" class="list-group">
                {% for player in room_data['players'] %}
                    <li class="list-group-item">{{ player['username'] }}</li>
                {% endfor %}
            </ul>
            {% if is_host %}
            <button onclick="startGame();">Start Game</button>
            {% endif %}
        </div>
    </center>
    <div class="center-block">
        <div id="widget-container" style="text-align:center; display:none">
        
        </div>
    </div>

{% endblock %}

{% block js %}
<script src="/static/js/render_widgets.js"></script>
<script>
    // updates playerlist whenever a player is added
    // we do not care for players being removed yet
    let playerList = $("#player-list")
    let players = []
    let isHost = {{ is_host|string|lower }};
    var prsIntervalId = -1
    
    function refreshPlayerList(initialCall) {
        $.ajax(window.location.href + "/state", {
            'dataType': 'json',
        })
            .done((obj) => {
                if (obj.widget_index != -1) {
                    clearInterval(plIntervalId);
                    prsIntervalId = setInterval(pollRoomState, 1000);
                    switch_to_widget_view();
                    displayRoomState(obj);
                    return;
                }
                newPlayers = obj.players
                if (initialCall) playerList.empty();
                for (var i = players.length; i < newPlayers.length; i++) {
                    playerList.append(
                        $('<li class="list-group-item">')
                            .append(newPlayers[i])
                    );
                }
                players = newPlayers;
            })
        
    }
    refreshPlayerList(true);
    var plIntervalId = setInterval(refreshPlayerList, 1000);
    
    {% if is_host %}
    function startGame() {
        $.ajax(window.location.href + "/begin")
            // .success(switch_to_game_view)
            .fail(startGame);
    }
    {% endif %}
    
    var currentIndex = -1;
    
    function pollRoomState() {
        $.ajax(window.location.href + "/state", {
            'dataType': 'json',
        }).done((obj) => {
            if (obj.widget_index != currentIndex) {
                displayRoomState(obj);
                currentIndex = obj.widget_index;
            }
        });
    }
    
    function switch_to_widget_view() {
        $("#pre-game").css("display", "none");
        $("#widget-container").css("display", "block");
    }
    
    
    function displayRoomState(room_state) {
        displayWidget(room_state.widget, isHost);
    }

</script>
{% endblock %}